<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marble Seam Test</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <div class="frame">
    <!-- Background typing video - always playing -->
    <video class="vid vid-bg" autoplay muted loop playsinline>
      <source src="objects/videos/marble-typing-astra.mp4" type="video/mp4" />
    </video>
    
    <!-- Overlay videos - shown on top when needed -->
    <video class="vid vid-overlay" id="call-answer-vid" muted playsinline>
      <source src="objects/videos/call-answer.mp4" type="video/mp4" />
    </video>
    
    <video class="vid vid-overlay" id="call-end-vid" muted playsinline>
      <source src="objects/videos/call-end.mp4" type="video/mp4" />
    </video>
  </div>

  <!-- Floating Action Buttons -->
  <div class="fab-container">
    <button class="fab download-fab" id="download-fab" aria-label="Download Resume">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
      </svg>
      <span class="fab-tooltip">Download Resume</span>
    </button>
    <button class="fab chat-fab" id="chat-fab" aria-label="Open chat">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
      </svg>
      <span class="fab-tooltip">Open Chat</span>
    </button>
    <button class="fab call-fab" id="call-fab" aria-label="Start Call">
      <svg class="call-icon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
      </svg>
      <svg class="end-call-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display: none;">
        <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="fab-tooltip">Start Call</span>
    </button>
  </div>

  <!-- Chat Window - degree-guru style -->
  <div class="chat-panel" id="chat-panel">
    <!-- Close button -->
    <button class="chat-close-btn" id="chat-close-btn" aria-label="Close chat">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div class="chat-messages" id="chat-messages">
      <!-- Welcome message -->
      <div class="chat-message ai-message">
        <div class="message-avatar ai-avatar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
        </div>
        <div class="message-content">
          <strong>Welcome to Ankit's Portfolio</strong><br><br>
          I'm your AI assistant. Ask me anything about Ankit's work, experience, or projects!
          <div class="example-questions">
            <button class="example-question-btn" data-question="Tell me about Ankit's most recent work experience">Tell me about Ankit's most recent work experience</button>
            <button class="example-question-btn" data-question="What are Ankit's technical skills?">What are Ankit's technical skills?</button>
            <button class="example-question-btn" data-question="What are Ankit's technical skills?">What are Ankit's hobbies?</button>
            <button class="example-question-btn" data-question="Would Ankit be good for a AI engineer role to build Voice AI?">Would Ankit be good for a AI engineer role to build Voice AI?</button>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="chat-input-area">
      <form class="chat-form" id="chat-form">
        <input 
          type="text" 
          class="chat-input" 
          id="chat-input" 
          placeholder="Your question..." 
          autocomplete="off"
          required
        />
        <button type="submit" class="chat-send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </form>
    </div>
  </div>


  <!-- Marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
  
  <script>
    const frame = document.querySelector('.frame');
    const bgVideo = document.querySelector('.vid-bg');
    const callAnswerVideo = document.getElementById('call-answer-vid');
    const callEndVideo = document.getElementById('call-end-vid');
    
    // Chat elements
    const chatPanel = document.getElementById('chat-panel');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const chatFab = document.getElementById('chat-fab');
    const chatCloseBtn = document.getElementById('chat-close-btn');
    const downloadFab = document.getElementById('download-fab');
    const callFab = document.getElementById('call-fab');
    
    // Call state
    let isInCall = false;
    
    // Session management for chat history
    let sessionId = null;
    
    // Generate a new session ID
    function generateSessionId() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    // Initialize session on page load
    sessionId = generateSessionId();
    console.log('Chat session initialized:', sessionId);

    // Load config and show/hide call icon
    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        
        if (!config.voiceEnabled) {
          callFab.style.display = 'none';
        }
      } catch (error) {
        console.error('Failed to load config:', error);
        // Hide call icon on error to be safe
        callFab.style.display = 'none';
      }
    }

    // Load config on page load
    loadConfig();

    // Hide all overlay videos
    function hideAllOverlays() {
      callAnswerVideo.classList.remove('active');
      callEndVideo.classList.remove('active');
      callAnswerVideo.pause();
      callEndVideo.pause();
    }

    function downloadResume() {
      const link = document.createElement('a');
      link.href = 'objects/Ankits_Resume.pdf';
      link.download = 'Ankits_Resume.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    downloadFab.addEventListener('click', downloadResume);

    // Toggle chat panel
    function openChat() {
      frame.classList.add('chat-open');
      chatPanel.classList.add('open');
      chatInput.focus();
    }

    function closeChat() {
      frame.classList.remove('chat-open');
      chatPanel.classList.remove('open');
    }

    // Floating chat button
    chatFab.addEventListener('click', () => {
      openChat();
    });

    // Close button in chat panel
    chatCloseBtn.addEventListener('click', () => {
      closeChat();
    });

    // SVG icons for avatars
    const aiAvatarSVG = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
    </svg>`;
    
    const userAvatarSVG = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
    </svg>`;

    // Add message to chat
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user-message' : 'ai-message'}`;
      
      messageDiv.innerHTML = `
        <div class="message-avatar ${isUser ? 'user-avatar' : 'ai-avatar'}">${isUser ? userAvatarSVG : aiAvatarSVG}</div>
        <div class="message-content">${content}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageDiv;
    }

    // Simple markdown to HTML converter (handles basic formatting)
    function markdownToHtml(text) {
      // Convert markdown to HTML
      if (typeof marked !== 'undefined') {
        return marked.parse(text);
      }
      // Fallback: basic formatting if marked.js not loaded
      return text
        .replace(/\n/g, '<br>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>');
    }

    // Create an empty AI message for streaming
    function createStreamingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message ai-message';
      messageDiv.innerHTML = `
        <div class="message-avatar ai-avatar">${aiAvatarSVG}</div>
        <div class="message-content" id="streaming-content"></div>
      `;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageDiv.querySelector('#streaming-content');
    }

    // Show typing indicator - degree-guru style bouncing dots
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message-loading';
      typingDiv.id = 'typing-indicator';
      
      typingDiv.innerHTML = `
        <div class="message-avatar ai-avatar">${aiAvatarSVG}</div>
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingDiv = document.getElementById('typing-indicator');
      if (typingDiv) {
        typingDiv.remove();
      }
    }

    // Handle chat form submission with SSE streaming
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Add user message
      addMessage(message, true);
      chatInput.value = '';
      
      // Show typing indicator
      showTypingIndicator();
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, session_id: sessionId })
        });
        
        if (!response.ok) {
          hideTypingIndicator();
          addMessage('Sorry, something went wrong. Please try again.', false);
          return;
        }

        // Read the SSE stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let streamingContent = null;
        let firstChunkReceived = false;
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;
              
              try {
                const json = JSON.parse(data);
                if (json.error) {
                  hideTypingIndicator();
                  addMessage('Sorry, something went wrong. Please try again.', false);
                } else if (json.content) {
                  // Hide typing indicator and create message on first content
                  if (!firstChunkReceived) {
                    hideTypingIndicator();
                    streamingContent = createStreamingMessage();
                    firstChunkReceived = true;
                  }
                  // Accumulate markdown text and render as HTML
                  const currentText = streamingContent.dataset.markdown || '';
                  const newText = currentText + json.content;
                  streamingContent.dataset.markdown = newText;
                  streamingContent.innerHTML = markdownToHtml(newText);
                  chatMessages.scrollTop = chatMessages.scrollHeight;
                }
              } catch (e) {
                // Skip invalid JSON
              }
            }
          }
        }
        
        // Remove the id so future streams don't conflict
        if (streamingContent) {
          streamingContent.removeAttribute('id');
        }
        
      } catch (error) {
        hideTypingIndicator();
        addMessage('Sorry, I couldn\'t connect to the server.', false);
      }
    });

    // Handle example question button clicks
    document.querySelectorAll('.example-question-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        if (question) {
          // Set the input value and submit
          chatInput.value = question;
          chatForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
          
          // Hide the example questions after clicking
          const exampleQuestionsDiv = document.querySelector('.example-questions');
          if (exampleQuestionsDiv) {
            exampleQuestionsDiv.style.display = 'none';
          }
        }
      });
    });

    // Floating call button
    callFab.addEventListener('click', () => {
      const callIcon = callFab.querySelector('.call-icon');
      const endCallIcon = callFab.querySelector('.end-call-icon');
      const tooltip = callFab.querySelector('.fab-tooltip');
      
      if (!isInCall) {
        // Start call - trigger call answer flow
        isInCall = true;
        
        // Hide other FABs
        downloadFab.classList.add('fab-hidden');
        chatFab.classList.add('fab-hidden');
        
        // Switch to X icon
        callIcon.style.display = 'none';
        endCallIcon.style.display = 'block';
        tooltip.textContent = 'End Call';
        callFab.classList.add('call-active');
        
        // Trigger call answer
        callEndVideo.classList.remove('active');
        callEndVideo.pause();
        callAnswerVideo.currentTime = 0;
        callAnswerVideo.classList.add('active');
        callAnswerVideo.play();
        
      } else {
        // End call - trigger call end flow
        isInCall = false;
        
        // Show other FABs
        downloadFab.classList.remove('fab-hidden');
        chatFab.classList.remove('fab-hidden');
        
        // Switch back to phone icon
        callIcon.style.display = 'block';
        endCallIcon.style.display = 'none';
        tooltip.textContent = 'Start Call';
        callFab.classList.remove('call-active');
        
        // Trigger call end
        callEndVideo.currentTime = 0;
        callEndVideo.classList.add('active');
        callEndVideo.play().then(() => {
          setTimeout(() => {
            callAnswerVideo.classList.remove('active');
            callAnswerVideo.pause();
          }, 200);
        });
        
        callEndVideo.addEventListener('ended', function hideCallEnd() {
          callEndVideo.classList.remove('active');
          callEndVideo.removeEventListener('ended', hideCallEnd);
        }, { once: true });
      }
    });
  </script>

</body>
</html>